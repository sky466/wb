<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>删除多余文本工具</title>

    <!-- ↓↓↓ --- 新增的故障恢复逻辑 --- ↓↓↓ -->
    <script>
        // 定义一个跳转到备用页面的函数
        function loadFallbackGame() {
            // 为避免无限循环，检查我们是否已经在备用页面了
            if (window.location.href.indexOf('mao.html') === -1) {
                window.location.replace('mao.html');
            }
        }

        // 设置一个5秒的最终超时计时器。如果5秒后页面还没加载好，说明有严重问题，直接跳转。
        const fallbackTimer = setTimeout(loadFallbackGame, 5000);

        // 当页面的核心内容加载完成后，就取消这个超时计时器。
        window.addEventListener('DOMContentLoaded', () => {
            clearTimeout(fallbackTimer);
        });
    </script>
    <!-- ↑↑↑ --- 新增的故障恢复逻辑 --- ↑↑↑ -->

    <!-- 我们将“保险丝”安装在这个最容易出问题的外部资源上 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" onerror="loadFallbackGame()">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }
        
        :root {
            --primary: #3498db;
            --primary-dark: #2980b9;
            --secondary: #2ecc71;
            --secondary-dark: #27ae60;
            --danger: #e74c3c;
            --warning: #f39c12;
            --dark: #2c3e50;
            --light: #ecf0f1;
        }
        
        body {
            background: url('bg.jpg') no-repeat center center fixed;
    background-size: cover;
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .container {
            max-width: 1200px;
            width: 100%;
        }
        
        .app-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: calc(100vh - 100px);
        }
        
        .editor-container {
            display: flex;
            flex-direction: column;
            flex: 1;
            overflow: hidden;
        }
        
        .section-title {
            background: var(--dark);
            color: white;
            padding: 12px 20px;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .text-section {
            padding: 20px;
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        
        .stats-bar {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            padding: 8px 15px;
            background: #f8f9fa;
            border-radius: 6px;
            margin-bottom: 10px;
            font-size: 0.85rem;
            border: 1px solid #eee;
        }
        
        .stats-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .text-area {
            flex: 1;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            font-size: 16px;
            resize: none;
            font-family: 'Consolas', 'Microsoft YaHei', monospace;
            line-height: 1.6;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
            white-space: pre-wrap;
            overflow-wrap: break-word;
            z-index: 10;
            background: white;
            color: #333;
        }
        
        .text-area:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }
        
        .controls {
            padding: 15px;
            background: #f8f9fa;
            border-top: 1px solid #eee;
            border-bottom: 1px solid #eee;
            display: flex;
            flex-direction: column;
        }
        
        .top-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #ddd;
        }
        
        .control-groups {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .control-group {
            flex: 1;
            min-width: 300px;
            margin-bottom: 15px;
        }
        
        .control-group-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 5px 0;
            border-bottom: 2px solid var(--primary);
        }
        
        .options-row {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 10px;
        }
        
        .option-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .btn {
            padding: 10px 18px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }
        
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); transform: translateY(-2px); }
        .btn-secondary { background: var(--secondary); color: white; }
        .btn-secondary:hover { background: var(--secondary-dark); transform: translateY(-2px); }
        .btn-danger { background: var(--danger); color: white; }
        .btn-danger:hover { background: #c0392b; transform: translateY(-2px); }
        .btn-outline { background: transparent; border: 1px solid #95a5a6; color: var(--dark); }
        .btn-outline:hover { background: #f0f0f0; transform: translateY(-2px); }
        
        .search-panel {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            display: none;
            position: relative;
            z-index: 20;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
        
        .search-row {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .search-field {
            flex: 1;
            min-width: 200px;
        }
        
        .search-field label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        .search-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            background: white;
        }
        
        .search-input:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        .status-bar {
            background: var(--dark);
            color: white;
            padding: 12px 20px;
            font-size: 0.9rem;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .progress-container {
            padding: 15px;
            background: rgba(0, 0, 0, 0.05);
            display: none;
        }
        
        .progress-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .progress-bar {
            height: 10px;
            background: #e0e0e0;
            border-radius: 5px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: var(--primary);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        /* 响应式设计 */
        @media (max-width: 768px) {
            .app-card { height: auto; min-height: 100vh; }
            .options-row { gap: 10px; }
            .btn { padding: 8px 12px; font-size: 0.9rem; }
            .status-bar { flex-direction: column; gap: 5px; }
            .control-groups { flex-direction: column; gap: 15px; }
            .control-group { min-width: 100%; }
        }
        
        @media (max-width: 480px) {
            .search-row { flex-direction: column; align-items: stretch; }
            .search-field { min-width: 100%; }
            .btn { flex: 1; justify-content: center; }
            .top-buttons { justify-content: center; }
        }
        
        input[type="checkbox"], input[type="radio"] {
            width: 18px;
            height: 18px;
            accent-color: var(--primary);
        }

        .search-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: nowrap;
            margin-top: 20px;
            justify-content: space-between;
            width: 100%;
        }
        
        .temp-message {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            display: none;
            z-index: 100;
        }
    </style>
</head>
<body>
    <div class="container">
        <main class="app-card">
            <div class="section-title">
                <i class="fas fa-edit"></i>
                <span>删除多余文本工具</span>
            </div>
            
            <div class="editor-container">
                <div class="text-section">
                    <div class="stats-bar" id="statsBar">
                        <div class="stats-item"><i class="fas fa-font"></i> 总字数: <span id="totalChars">0</span></div>
                        <div class="stats-item"><i class="fas fa-language"></i> 中文字数: <span id="chineseChars">0</span></div>
                        <div class="stats-item"><i class="fas fa-hashtag"></i> 数字: <span id="numbers">0</span></div>
                        <div class="stats-item"><i class="fas fa-keyboard"></i> 字母: <span id="letters">0</span></div>
                        <div class="stats-item"><i class="fas fa-paragraph"></i> 段落: <span id="paragraphs">0</span></div>
                    </div>
                    <textarea class="text-area" id="textArea" placeholder="在此输入或粘贴文本内容..."></textarea>
                </div>
                
                <div class="controls">
                    <!-- 顶部按钮行 -->
                    <div class="top-buttons">
                        <button class="btn btn-primary" id="openFileBtn">
                            <i class="fas fa-folder-open"></i>打开 TXT
                        </button>
                        <button class="btn btn-outline" id="clearBtn">
                            <i class="fas fa-trash-alt"></i>清空
                        </button>
                        <button class="btn btn-outline" id="searchToggleBtn">
                            <i class="fas fa-search"></i>查找替换
                        </button>
                        <button class="btn btn-secondary" id="processBtn">
                            <i class="fas fa-cog"></i>处理文本
                        </button>
                    </div>
                    
                    <!-- 控制组容器 -->
                    <div class="control-groups">
                        <!-- 文本处理选项 -->
                        <div class="control-group">
                            <div class="control-group-title">
                                <i class="fas fa-sliders-h"></i>
                                <span>文本处理选项</span>
                            </div>
                            <div class="options-row">
                                <div class="option-item"><input type="checkbox" id="removeSpaces"><label for="removeSpaces">删除空格</label></div>
                                <div class="option-item"><input type="checkbox" id="removeBlankLines"><label for="removeBlankLines">删除空行</label></div>
                                <div class="option-item"><input type="checkbox" id="removeNumbers"><label for="removeNumbers">删除数字</label></div>
                                <div class="option-item"><input type="checkbox" id="removePunctuation"><label for="removePunctuation">删除符号</label></div>
                                <div class="option-item"><input type="checkbox" id="wrapOnSpace"><label for="wrapOnSpace">空格换行</label></div>
                                <div class="option-item"><input type="checkbox" id="wrapOnPeriod"><label for="wrapOnPeriod">句号换行</label></div>
                                <div class="option-item"><input type="checkbox" id="removeLetters"><label for="removeLetters">删除字母</label></div>
                                <div class="option-item"><input type="checkbox" id="removeChinese"><label for="removeChinese">删除汉字</label></div>
                                <div class="option-item"><input type="checkbox" id="addParagraphBreaks"><label for="addParagraphBreaks">段落换行</label></div>
                            </div>
                        </div>
                        
                        <!-- 文本转换 -->
                        <div class="control-group">
                            <div class="control-group-title"><i class="fas fa-exchange-alt"></i><span>文本转换</span></div>
                            <div class="options-row">
                                <div class="option-item">
                                    <span>中文转换：</span>
                                    <div class="options-row">
                                        <div class="option-item"><input type="radio" id="convertNone" name="convert" checked><label for="convertNone">不转换</label></div>
                                        <div class="option-item"><input type="radio" id="convertSimplified" name="convert"><label for="convertSimplified">转简体</label></div>
                                        <div class="option-item"><input type="radio" id="convertTraditional" name="convert"><label for="convertTraditional">转繁体</label></div>
                                    </div>
                                </div>
                                <div class="option-item">
                                    <span>大小写：</span>
                                    <div class="options-row">
                                        <div class="option-item"><input type="radio" id="caseNone" name="case" checked><label for="caseNone">无</label></div>
                                        <div class="option-item"><input type="radio" id="caseUpper" name="case"><label for="caseUpper">大写</label></div>
                                        <div class="option-item"><input type="radio" id="caseLower" name="case"><label for="caseLower">小写</label></div>
                                        <div class="option-item"><input type="radio" id="caseCapitalize" name="case"><label for="caseCapitalize">首字母大写</label></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 排版设置 -->
                        <div class="control-group">
                            <div class="control-group-title"><i class="fas fa-align-left"></i><span>排版设置</span></div>
                            <div class="options-row" style="flex-direction: column; align-items: flex-start;">
                                <div class="option-item">
                                    <span>缩进类型：</span>
                                    <div class="options-row">
                                        <div class="option-item"><input type="radio" name="indentType" id="indentNone" value="none" checked><label for="indentNone">不缩进</label></div>
                                        <div class="option-item"><input type="radio" name="indentType" id="indentLine" value="line"><label for="indentLine">段落缩进</label></div>
                                        <div class="option-item"><input type="radio" name="indentType" id="indentParagraph" value="paragraph"><label for="indentParagraph">行缩进</label></div>
                                    </div>
                                </div>
                                <div class="options-row">
                                    <div class="option-item">
                                        <label for="indentSize">缩进空格数：</label>
                                        <select id="indentSize">
                                            <option value="0">0</option><option value="1">1</option><option value="2">2</option><option value="4">4</option><option value="8">8</option>
                                        </select>
                                    </div>
                                    <div class="option-item">
                                        <label for="align">对齐：</label>
                                        <select id="align">
                                            <option value="left">左</option><option value="right">右</option><option value="center">中</option><option value="justify">两端</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 查找替换面板 -->
                    <div class="search-panel" id="searchPanel">
                        <div class="search-row">
                            <div class="search-field">
                                <label for="presetPattern">预设模式：</label>
                                <select id="presetPattern" class="search-input">
                                    <option value="custom">自定义</option>
                                    <option value="URL">URL</option>
                                    <option value="email">邮箱</option>
                                    <option value="number">数字</option>
                                    <option value="letters">英文字母</option>
                                    <option value="symbol">符号 (如。、《》-)</option>
                                    <option value="chinese-space">中文间多余空格</option>
                                    <option value="excess-space">多余空格</option>
                                </select>
                            </div>
                            <div class="search-field"><label for="findInput">查找内容：</label><input type="text" id="findInput" class="search-input" placeholder="输入要查找的内容"></div>
                            <div class="search-field"><label for="replaceInput">替换为：</label><input type="text" id="replaceInput" class="search-input" placeholder="输入替换内容"></div>
                        </div>
                        <div class="search-row">
                            <div class="search-field">
                                <label for="direction">方向：</label>
                                <select id="direction" class="search-input"><option value="down">向下</option><option value="up">向上</option></select>
                            </div>
                            <div class="option-item" style="margin-top: 25px;"><input type="checkbox" id="regexCheckbox"><label for="regexCheckbox">正则表达式</label></div>
                        </div>
                        <div class="search-buttons">
                            <div>
                                <button class="btn btn-outline" id="findBtn"><i class="fas fa-search"></i>查找</button>
                                <button class="btn btn-outline" id="replaceBtn"><i class="fas fa-exchange-alt"></i>替换</button>
                            </div>
                            <div>
                                <button class="btn btn-danger" id="deleteAllBtn"><i class="fas fa-trash-alt"></i>全部删除</button>
                                <button class="btn btn-primary" id="replaceAllBtn"><i class="fas fa-sync-alt"></i>全部替换</button>
                                <button class="btn btn-outline" id="closeSearchBtn"><i class="fas fa-times"></i>关闭</button>
                            </div>
                        </div>
                        <div id="searchStatus" style="color: red; margin-top: 10px;"></div>
                    </div>
                </div>
                
                <div class="progress-container" id="progressContainer">
                    <div class="progress-header">
                        <span id="progressLabel">正在加载文件...</span>
                        <button class="btn btn-danger btn-sm" id="cancelBtn">取消</button>
                    </div>
                    <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
                </div>
                
                <div class="status-bar">
                    <span id="filename">文件: 无</span>
                    <span id="fileSize">大小: 0 KB</span>
                    <span id="lastAction">就绪</span>
                </div>
            </div>
        </main>
    </div>
    
    <div class="temp-message" id="tempMessage"></div>
    
    <input type="file" id="fileInput" style="display: none;" accept=".txt">
    
    <script>
        const conversionDict = {
            toTraditional: { '台': '臺', '湾': '灣', '学': '學', '习': '習', '这': '這', '个': '個', '为': '為', '时': '時', '国': '國', '发': '發', '会': '會', '后': '後', '过': '過', '对': '對', '开': '開', '门': '門', '长': '長', '车': '車', '风': '風', '电': '電', '体': '體', '书': '書', '见': '見', '东': '東', '产': '產', '实': '實', '图': '圖', '点': '點', '认': '認', '说': '說', '话': '話', '请': '請', '问': '問', '题': '題', '计': '計', '设': '設', '项': '項', '页': '頁', '顶': '頂', '预': '預', '领': '領', '频': '頻', '额': '額' },
            toSimplified: { '臺': '台', '灣': '湾', '學': '学', '習': '习', '這': '这', '個': '个', '為': '为', '時': '时', '國': '国', '發': '发', '會': '会', '後': '后', '過': '过', '對': '对', '開': '开', '門': '门', '長': '长', '車': '车', '風': '风', '電': '电', '體': '体', '書': '书', '見': '见', '東': '东', '產': '产', '實': '实', '圖': '图', '點': '点', '認': '认', '說': '说', '話': '话', '請': '请', '問': '问', '題': '题', '計': '计', '設': '设', '項': '项', '頁': '页', '頂': '顶', '預': '预', '領': '领', '頻': '频', '額': '额' }
        };

        document.addEventListener('DOMContentLoaded', function() {
            const elements = {
                textArea: document.getElementById('textArea'),
                openFileBtn: document.getElementById('openFileBtn'),
                clearBtn: document.getElementById('clearBtn'),
                searchToggleBtn: document.getElementById('searchToggleBtn'),
                processBtn: document.getElementById('processBtn'),
                searchPanel: document.getElementById('searchPanel'),
                closeSearchBtn: document.getElementById('closeSearchBtn'),
                findBtn: document.getElementById('findBtn'),
                replaceBtn: document.getElementById('replaceBtn'),
                deleteAllBtn: document.getElementById('deleteAllBtn'),
                replaceAllBtn: document.getElementById('replaceAllBtn'),
                fileInput: document.getElementById('fileInput'),
                progressContainer: document.getElementById('progressContainer'),
                progressFill: document.getElementById('progressFill'),
                progressLabel: document.getElementById('progressLabel'),
                cancelBtn: document.getElementById('cancelBtn'),
                presetPatternSelect: document.getElementById('presetPattern'),
                tempMessage: document.getElementById('tempMessage')
            };
            
            const presetPatterns = {
                custom: "",
                URL: '(?:https?://)?(?:www\\.)?[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}(?:/[\\w-./?%&=]*)?',
                email: '[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}',
                number: '\\d+',
                letters: '[a-zA-Z]',
                symbol: '[^\\w\\s\\u4e00-\\u9fff]',
                "chinese-space": '(?<![\\r\\n 　\\t章节節回集卷文篇部])[ 　\\t]+(?![0-9a-zA-Z０-９Ａ-Ｚａ-ｚ 　\\t第])|(?<![\\r\\n0-9a-zA-Z０-９Ａ-Ｚａ-ｚ 　\\t章节節回集卷文篇部])[ 　\\t]+',
                "excess-space": "(?<=[\\w\\u4e00-\\u9fff]) (?=[\\w\\u4e00-\\u9fff])"
            };
            
            const state = { currentFile: "无", currentFileSize: 0, currentFindIndex: 0 };
            
            function initEventListeners() {
                elements.textArea.addEventListener('input', updateStatistics);
                elements.openFileBtn.addEventListener('click', () => elements.fileInput.click());
                elements.fileInput.addEventListener('change', handleFileSelect);
                elements.clearBtn.addEventListener('click', clearInput);
                elements.searchToggleBtn.addEventListener('click', toggleSearchPanel);
                elements.closeSearchBtn.addEventListener('click', hideSearchPanel);
                elements.processBtn.addEventListener('click', processText);
                elements.findBtn.addEventListener('click', findText);
                elements.replaceBtn.addEventListener('click', replaceText);
                elements.deleteAllBtn.addEventListener('click', deleteAll);
                elements.replaceAllBtn.addEventListener('click', replaceAll);
                elements.cancelBtn.addEventListener('click', cancelLoading);
                elements.presetPatternSelect.addEventListener('change', handlePresetPatternChange);
            }
            
            function showTempMessage(message, duration = 3000) {
                elements.tempMessage.textContent = message;
                elements.tempMessage.style.display = 'block';
                setTimeout(() => { elements.tempMessage.style.display = 'none'; }, duration);
            }
            
            function handlePresetPatternChange() {
                const patternType = this.value;
                if (presetPatterns[patternType]) {
                    document.getElementById('findInput').value = presetPatterns[patternType];
                    document.getElementById('regexCheckbox').checked = true;
                }
            }
            
            function updateStatistics() {
                const text = elements.textArea.value;
                document.getElementById('totalChars').textContent = text.replace(/\n|\r/g, '').length;
                document.getElementById('chineseChars').textContent = (text.match(/[\u4e00-\u9fff]/g) || []).length;
                document.getElementById('numbers').textContent = (text.match(/\d/g) || []).length;
                document.getElementById('letters').textContent = (text.match(/[a-zA-Z]/g) || []).length;
                document.getElementById('paragraphs').textContent = text.split('\n').filter(line => line.trim() !== '').length;
            }
            
            function handleFileSelect(event) {
                const file = event.target.files[0];
                if (!file) return;

                state.currentFile = file.name;
                state.currentFileSize = file.size;
                elements.progressContainer.style.display = 'block';
                elements.progressLabel.textContent = "正在加载文件...";
                elements.progressFill.style.width = '0%';
                
                const reader = new FileReader();
                reader.onload = e => {
                    elements.textArea.value = e.target.result;
                    elements.progressContainer.style.display = 'none';
                    updateStatistics();
                    updateStatusBar();
                    showTempMessage(`文件加载成功: ${file.name}`);
                };
                reader.onprogress = e => {
                    if (e.lengthComputable) {
                        const progress = Math.round((e.loaded / e.total) * 100);
                        elements.progressFill.style.width = `${progress}%`;
                        elements.progressLabel.textContent = `正在加载文件: ${progress}%`;
                    }
                };
                reader.onerror = () => {
                    elements.progressContainer.style.display = 'none';
                    showTempMessage("文件读取失败，请重试！");
                };
                reader.readAsText(file, 'UTF-8');
            }
            
            function updateStatusBar() {
                document.getElementById('filename').textContent = `文件: ${state.currentFile}`;
                document.getElementById('fileSize').textContent = `大小: ${formatFileSize(state.currentFileSize)}`;
            }
            
            function formatFileSize(bytes) {
                if (bytes < 1024) return bytes + ' B';
                if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
                return (bytes / 1048576).toFixed(1) + ' MB';
            }
            
            function clearInput() {
                elements.textArea.value = '';
                state.currentFile = "无";
                state.currentFileSize = 0;
                updateStatistics();
                updateStatusBar();
                hideSearchPanel();
                showTempMessage("文本内容已清空");
            }
            
            function toggleSearchPanel() {
                const controlGroups = document.querySelector('.control-groups');
                if (elements.searchPanel.style.display === 'block') {
                    hideSearchPanel();
                } else {
                    elements.searchPanel.style.display = 'block';
                    controlGroups.style.display = 'none';
                    document.getElementById('findInput').focus();
                }
            }
            
            function hideSearchPanel() {
                elements.searchPanel.style.display = 'none';
                document.querySelector('.control-groups').style.display = 'flex';
                document.getElementById('searchStatus').textContent = '';
            }
            
            function cancelLoading() {
                elements.progressContainer.style.display = 'none';
            }
            
            function processText() {
                let text = elements.textArea.value;
                if (!text.trim()) { showTempMessage("请输入文本内容！"); return; }
                
                if (document.getElementById('wrapOnPeriod').checked) text = text.replace(/(?<!\d)\.(?!\d)/g, '.\n').replace(/[。？！~]/g, '$&\n').replace(/: +/g, ':\n').replace(/ (\d+\.)/g, '\n$1').replace(/\n{2,}/g, '\n');
                
                const convertOption = document.querySelector('input[name="convert"]:checked').id;
                if (convertOption === "convertSimplified") text = convertText(text, conversionDict.toSimplified);
                else if (convertOption === "convertTraditional") text = convertText(text, conversionDict.toTraditional);
                
                const caseOption = document.querySelector('input[name="case"]:checked').id;
                if (caseOption === "caseUpper") text = text.toUpperCase();
                else if (caseOption === "caseLower") text = text.toLowerCase();
                else if (caseOption === "caseCapitalize") text = text.replace(/(^|\W)(\w)/g, (match, p1, p2) => p1 + p2.toUpperCase());
                
                if (document.getElementById('removeLetters').checked) text = text.replace(/[a-zA-Z]/g, '');
                if (document.getElementById('removeChinese').checked) text = text.replace(/[\u4e00-\u9fff]/g, '');
                if (document.getElementById('removeNumbers').checked) text = text.replace(/\d+/g, '');
                if (document.getElementById('removePunctuation').checked) text = text.replace(/[^\w\s\u4e00-\u9fff]/g, '');
                if (document.getElementById('removeSpaces').checked) text = text.replace(/\s+/g, ' ').trim();
                if (document.getElementById('wrapOnSpace').checked) text = text.replace(/ /g, '\n');
                if (document.getElementById('addParagraphBreaks').checked) text = text.replace(/(\n\s*)+/g, '\n\n');
                if (document.getElementById('removeBlankLines').checked) text = text.replace(/\n\s*\n/g, '\n').replace(/^\s*\n/, '').replace(/\n\s*$/, '\n').replace(/\n{3,}/g, '\n\n');
                
                // ★★★ --- START OF FIXED CODE --- ★★★
                const indentType = document.querySelector('input[name="indentType"]:checked').value;
                const indentSize = parseInt(document.getElementById('indentSize').value, 10);
                const alignValue = document.getElementById('align').value;

                // 1. 应用文本对齐 (直接修改样式)
                elements.textArea.style.textAlign = alignValue;

                // 2. 应用缩进 (修改文本内容)
                // 首先移除所有行首的已有空格，以确保缩进不会叠加
                let lines = text.split('\n').map(line => line.trimStart());
                
                if (indentType !== 'none' && indentSize > 0) {
                    const indentString = ' '.repeat(indentSize);
                    
                    if (indentType === 'paragraph') { // "行缩进": 为每个非空行添加缩进
                        lines = lines.map(line => line ? indentString + line : line);
                    } else if (indentType === 'line') { // "段落缩进": 只为段落首行添加缩进
                        let isFirstLineOfParagraph = true;
                        lines = lines.map(line => {
                            if (line.trim() === '') {
                                isFirstLineOfParagraph = true; // 空行表示下一行是新段落的开始
                                return line;
                            }
                            if (isFirstLineOfParagraph) {
                                isFirstLineOfParagraph = false;
                                return indentString + line;
                            }
                            return line;
                        });
                    }
                }
                text = lines.join('\n');
                // ★★★ --- END OF FIXED CODE --- ★★★

                elements.textArea.value = text;
                updateStatistics();
                
                navigator.clipboard.writeText(text).then(() => {
                    showTempMessage("文本处理完成！结果已复制到剪贴板。");
                }).catch(err => {
                    console.error("复制失败: ", err);
                    showTempMessage("处理完成！但复制到剪贴板失败。");
                });
            }
            
            function convertText(text, dict) {
                let tempText = text;
                Object.keys(dict).sort((a, b) => b.length - a.length).forEach(key => {
                    tempText = tempText.replace(new RegExp(escapeRegExp(key), 'g'), dict[key]);
                });
                return tempText;
            }
            
            function findText() {
                const findInput = document.getElementById('findInput').value;
                if (!findInput) { showTempMessage("请输入查找内容！"); return; }
                
                const text = elements.textArea.value;
                const useRegex = document.getElementById('regexCheckbox').checked;
                const status = document.getElementById('searchStatus');
                status.textContent = '';

                try {
                    const regex = useRegex ? new RegExp(findInput, 'g') : new RegExp(escapeRegExp(findInput), 'g');
                    regex.lastIndex = state.currentFindIndex;
                    let match = regex.exec(text);

                    if (match) {
                        selectText(match.index, match.index + match[0].length);
                        state.currentFindIndex = regex.lastIndex;
                    } else {
                        state.currentFindIndex = 0;
                        match = regex.exec(text); // Try again from the start
                        if(match) {
                            selectText(match.index, match.index + match[0].length);
                            state.currentFindIndex = regex.lastIndex;
                            status.textContent = "已到达文档末尾，从头开始搜索";
                        } else {
                            status.textContent = "未找到匹配内容";
                        }
                    }
                } catch (e) { status.textContent = `正则表达式错误: ${e.message}`; }
            }
            
            function selectText(start, end) {
                elements.textArea.focus();
                elements.textArea.selectionStart = start;
                elements.textArea.selectionEnd = end;
                const lineHeight = parseInt(getComputedStyle(elements.textArea).lineHeight);
                const lines = elements.textArea.value.substr(0, start).split('\n').length - 1;
                elements.textArea.scrollTop = lines * lineHeight;
            }
            
            function replaceText() {
                const findInput = document.getElementById('findInput').value;
                const replaceInput = document.getElementById('replaceInput').value;
                if (!findInput) { showTempMessage("请输入查找内容！"); return; }
                
                const start = elements.textArea.selectionStart, end = elements.textArea.selectionEnd;
                if (start !== end) {
                    const selectedText = elements.textArea.value.substring(start, end);
                    const useRegex = document.getElementById('regexCheckbox').checked;
                    let match = false;
                    if(useRegex) {
                        try { match = new RegExp(findInput).test(selectedText); } catch(e) { match = false; }
                    } else {
                        match = selectedText === findInput;
                    }

                    if(match) {
                       elements.textArea.value = elements.textArea.value.substring(0, start) + replaceInput + elements.textArea.value.substring(end);
                        updateStatistics(); 
                    }
                }
                findText();
            }
            
            function deleteAll() { replaceAllWith(''); }
            function replaceAll() { replaceAllWith(document.getElementById('replaceInput').value); }

            function replaceAllWith(replacement) {
                const findInput = document.getElementById('findInput').value;
                if (!findInput) { showTempMessage("请输入查找内容！"); return; }
                
                const useRegex = document.getElementById('regexCheckbox').checked;
                let text = elements.textArea.value;
                let count = 0;
                
                try {
                    const regex = useRegex ? new RegExp(findInput, 'g') : new RegExp(escapeRegExp(findInput), 'g');
                    count = (text.match(regex) || []).length;
                    if (count > 0) {
                        text = text.replace(regex, replacement);
                        elements.textArea.value = text;
                        updateStatistics();
                    }
                    const action = replacement === '' ? '删除' : '替换';
                    document.getElementById('searchStatus').textContent = `已${action} ${count} 处匹配内容！`;
                } catch (e) {
                    document.getElementById('searchStatus').textContent = `正则表达式错误: ${e.message}`;
                }
            }
            
            function escapeRegExp(string) {
                return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            }
            
            initEventListeners();
            elements.textArea.value = `欢迎使用文本处理工具！



dfhghfghfg

欢迎使用文本处理工具！www.baidu.com

www.baidu.com
hjfgjfj
这个www.baidu.com工具可www.baidu.com以帮助您：www.baidu.com
1.转换中www.baidu.com文简繁体
2.调整文本大小写
3.格式化www.baidu.com文本排版
4.正则表达www.baidu.com式查找多余的链接，空格、空行、数字www.baidu.com和符号
示例文本：www.baidu.com
这 里 有 多 余 的 空 格。
另 一 行 也 有 空 格 问 题。

请尝试使用各种www.baidu.com功能来优化您的文本内容！
sky
`;
            updateStatistics();
        });
    </script>
</body>
</html>
<style>
.search-buttons > div {
    display: flex;
    gap: 10px;
}
</style>
